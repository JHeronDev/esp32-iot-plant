services:
  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: mqtt-broker
    restart: unless-stopped
    ports:
      - "0.0.0.0:1883:1883"
      - "0.0.0.0:9001:9001"
    volumes:
      - ./mqtt-docker/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mqtt_data:/mosquitto/data
      - mqtt_log:/mosquitto/log
    networks:
      - iot-network
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-W", "3"]
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    image: postgres:16-alpine
    container_name: postgres-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-iot_plant}
      POSTGRES_USER: ${POSTGRES_USER:-iot_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-iot_password}
    volumes:
      - ./mqtt-docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
      - postgres_data:/var/lib/postgresql/data
    networks:
      - iot-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-iot_user}"]
      interval: 10s
      timeout: 5s
      retries: 5

  influxdb:
    image: influxdb:2.7-alpine
    container_name: influxdb
    restart: unless-stopped
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUX_USER:-admin}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUX_PASSWORD:-adminpassword}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUX_ORG:-iot_org}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUX_BUCKET:-plant_data}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUX_TOKEN:-mytoken123456}
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    ports:
      - "0.0.0.0:8086:8086"
    networks:
      - iot-network
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  web:
    build: ./web-mqtt
    container_name: web-app
    restart: unless-stopped
    ports:
      - "0.0.0.0:3000:3000"
    depends_on:
      - mosquitto
      - postgres
      - influxdb
    volumes:
      - ./web-mqtt/public:/app/public
    environment:
      - NODE_ENV=production
      - MQTT_BROKER=mqtt://mosquitto:1883
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DATABASE=${POSTGRES_DB:-iot_plant}
      - POSTGRES_USER=${POSTGRES_USER:-iot_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-iot_password}
      - INFLUX_URL=http://influxdb:8086
      - INFLUX_TOKEN=${INFLUX_TOKEN:-mytoken123456}
      - INFLUX_ORG=${INFLUX_ORG:-iot_org}
      - INFLUX_BUCKET=${INFLUX_BUCKET:-plant_data}
    networks:
      - iot-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3

  reverse-proxy:
    image: nginx:alpine
    container_name: reverse-proxy
    restart: unless-stopped
    ports:
      - "0.0.0.0:80:80"
    volumes:
      - ./mqtt-docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - web
    networks:
      - iot-network

networks:
  iot-network:
    driver: bridge

volumes:
  mqtt_data:
  mqtt_log:
  postgres_data:
  influxdb_data:
  influxdb_config:
