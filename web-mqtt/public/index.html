<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üå± Serre connect√©e</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      background: #1e293b;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    h1 { font-size: 1.5rem; font-weight: 600; }

    #status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(239,68,68,0.1);
      border: 1px solid #ef4444;
      border-radius: 20px;
      font-size: 0.875rem;
      color: #ef4444;
    }

    #status.connected {
      background: rgba(16,185,129,0.1);
      border-color: #10b981;
      color: #10b981;
    }

    #status::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.75rem;
      overflow: auto;
    }

    section {
      background: #1e293b;
      border-radius: 12px;
      padding: 0.75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.05);
    }

    section:first-of-type {
      flex-shrink: 0;
    }

    section:last-of-type {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 300px;
    }

    h2 {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      text-align: center;
    }

    #sensors {
      display: flex;
      gap: 0.5rem;
      flex-wrap: nowrap;
    }

    .sensor-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.35rem;
      flex: 1;
      min-width: 0;
    }

    .indicator {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .bubble {
      width: 75px;
      height: 75px;
      border-radius: 50%;
      background: rgba(255,255,255,0.02);
      border: 2px solid rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.2rem;
      transition: all 0.3s;
    }

    .bubble.healthy { border-color: #10b981; }
    .bubble.warning { border-color: #f59e0b; }
    .bubble.critical { border-color: #ef4444; }

    .bubble label {
      font-size: 0.65rem;
      color: #94a3b8;
      text-transform: uppercase;
      font-weight: 600;
    }

    .bubble .value {
      font-size: 1.3rem;
      font-weight: 700;
    }

    .bubble .unit {
      font-size: 0.65rem;
      color: #94a3b8;
    }

    .btn-circle {
      width: 75px;
      height: 75px;
      border-radius: 50%;
      background: #475569;
      border: 2px solid #64748b;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.2rem;
      transition: all 0.3s;
      cursor: pointer;
    }

    .btn-circle:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(100,116,139,0.4);
    }

    .btn-circle.on {
      background: #10b981;
      border-color: #059669;
    }

    .btn-circle.on:hover {
      box-shadow: 0 0 20px rgba(16,185,129,0.5);
    }

    .btn-circle .icon {
      font-size: 1.5rem;
      filter: grayscale(100%);
      opacity: 0.6;
    }

    .btn-circle.on .icon {
      filter: grayscale(0%);
      opacity: 1;
    }

    .btn-circle .label {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.7);
      font-weight: 600;
      text-align: center;
    }

    .btn-circle.on .label {
      color: rgba(255,255,255,0.95);
    }

    #chart-section {
      flex: 1;
      min-width: 400px;
      display: flex;
      flex-direction: column;
    }

    #chart-wrapper {
      flex: 1;
      position: relative;
      min-height: 0;
    }

    canvas {
      max-height: 100% !important;
      width: 100% !important;
    }

    h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    /* Login Panel */
    #login-panel {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
      font-size: 0.875rem;
    }

    #login-panel.authenticated {
      background: transparent;
    }

    .login-inputs {
      display: flex;
      gap: 0.5rem;
    }

    .login-inputs input {
      flex: 1;
      padding: 0.5rem;
      background: #0f172a;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      color: #e2e8f0;
      font-size: 0.75rem;
    }

    .login-inputs input:focus {
      outline: none;
      border-color: #10b981;
    }

    .login-btn, .logout-btn {
      padding: 0.5rem 1rem;
      background: #10b981;
      border: none;
      border-radius: 4px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.75rem;
    }

    .login-btn:hover {
      background: #059669;
    }

    .logout-btn {
      background: #ef4444;
    }

    .logout-btn:hover {
      background: #dc2626;
    }

    #login-error {
      color: #ef4444;
      font-size: 0.7rem;
      text-align: center;
      display: none;
      min-height: 0.9rem;
    }

    #auth-status {
      display: none;
      align-items: center;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .user-chip {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
      font-weight: 700;
      color: #e2e8f0;
    }

    .btn-circle:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-circle.disabled,
    .btn-circle.disabled:hover {
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }

    .section-header h2 {
      margin: 0;
      flex: 1;
    }

    .ghost-btn {
      padding: 0.35rem 0.75rem;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.05);
      color: #e2e8f0;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .ghost-btn:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.3);
    }
  </style>
</head>
<body>

<header>
  <h1>üå± Serre connect√©e</h1>
  <div id="status">D√©connect√©</div>
  <div id="login-panel">
    <div class="login-inputs">
      <input type="text" id="username" placeholder="Utilisateur">
      <input type="password" id="password" placeholder="Mot de passe">
      <button class="login-btn" onclick="handleLogin()">Connexion</button>
    </div>
    <div id="login-error"></div>
    <div id="auth-status" style="display:none;"></div>
  </div>
</header>

<main>
  <section>
    <div class="section-header">
      <h2>Capteurs</h2>
      <button class="ghost-btn" id="settings-toggle" onclick="toggleSettingsSection()">‚öôÔ∏è Param√®tres</button>
    </div>
    <div id="sensors">
      <!-- Luminosit√© -->
      <div class="sensor-item">
        <div class="indicator">
          <div class="bubble" id="lux-bubble">
            <label>Lumi</label>
            <div class="value" id="lux">-</div>
            <div class="unit">lux</div>
          </div>
        </div>
        <div class="btn-circle disabled" id="led-btn" onclick="toggle('led', 'LED')">
          <div class="icon">üí°</div>
          <div class="label">Lumi√®re</div>
        </div>
      </div>

      <!-- Humidit√© -->
      <div class="sensor-item">
        <div class="indicator">
          <div class="bubble" id="soil-bubble">
            <label>Humi</label>
            <div class="value" id="soil">-</div>
            <div class="unit">%</div>
          </div>
        </div>
        <div class="btn-circle disabled" id="hum-btn" onclick="toggle('hum', 'HUM')">
          <div class="icon">üíß</div>
          <div class="label">Arrosage</div>
        </div>
      </div>

      <!-- Temp√©rature -->
      <div class="sensor-item">
        <div class="indicator">
          <div class="bubble" id="temp-bubble">
            <label>Temp</label>
            <div class="value" id="temp">-</div>
            <div class="unit">¬∞C</div>
          </div>
        </div>
        <div class="btn-circle disabled" id="fan-btn" onclick="toggle('fan', 'FAN')">
          <div class="icon">üåÄ</div>
          <div class="label">Ventilation</div>
        </div>
      </div>

      <!-- Pression (sans bouton) -->
      <div class="sensor-item">
        <div class="indicator">
          <div class="bubble" id="pressure-bubble">
            <label>Press</label>
            <div class="value" id="pressure">-</div>
            <div class="unit">hPa</div>
          </div>
        </div>
      </div>

      <!-- WiFi (sans bouton) -->
      <div class="sensor-item">
        <div class="indicator">
          <div class="bubble" id="rssi-bubble">
            <label>WiFi</label>
            <div class="value" id="rssi">-</div>
            <div class="unit">dB</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="chart-section">
    <h2>üìà Historique</h2>
    <div id="chart-wrapper">
      <canvas id="chart"></canvas>
    </div>
  </section>
</main>

<script>
  const socket = io({ reconnection: true, reconnectionDelay: 1000 });
  let chart = null;
  let states = { led: false, hum: false, fan: false };
  let token = localStorage.getItem('auth_token');
  let currentUsername = localStorage.getItem('username');
  let isAuthenticated = false;

  function setLoginError(msg) {
    const el = document.getElementById('login-error');
    if (msg) {
      el.textContent = msg;
      el.style.display = 'block';
    } else {
      el.textContent = '';
      el.style.display = 'none';
    }
  }

  // Afficher l'utilisateur connect√© si le token existe
  if (token) {
    showAuthInfo();
    socket.emit('auth', token);
  } else {
    disableButtons();
  }

  async function handleLogin() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    if (!username || !password) {
      setLoginError('Veuillez remplir tous les champs');
      return;
    }

    try {
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      if (res.ok) {
        const data = await res.json();
        token = data.token;
        currentUsername = data.username;
        localStorage.setItem('auth_token', token);
        localStorage.setItem('username', currentUsername);
        
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        setLoginError('');
        
        socket.emit('auth', token);
        isAuthenticated = true;
        showAuthInfo();
        enableButtons();
      } else {
        const error = await res.json();
        setLoginError(error.error || 'Erreur de connexion');
      }
    } catch (err) {
      setLoginError('Erreur r√©seau');
    }
  }

  function showAuthInfo() {
    const loginInputs = document.querySelector('.login-inputs');
    const authStatus = document.getElementById('auth-status');
    
    loginInputs.style.display = 'none';
    authStatus.style.display = 'flex';
    authStatus.innerHTML = `
      <span class="user-chip">üë§ ${currentUsername}</span>
      <button class="logout-btn" onclick="logout()">D√©connexion</button>
    `;
  }

  function enableButtons() {
    document.getElementById('led-btn').classList.remove('disabled');
    document.getElementById('hum-btn').classList.remove('disabled');
    document.getElementById('fan-btn').classList.remove('disabled');
  }

  function disableButtons() {
    document.getElementById('led-btn').classList.add('disabled');
    document.getElementById('hum-btn').classList.add('disabled');
    document.getElementById('fan-btn').classList.add('disabled');
  }

  function logout() {
    localStorage.removeItem('auth_token');
    localStorage.removeItem('username');
    token = null;
    currentUsername = null;
    isAuthenticated = false;
    
    const loginInputs = document.querySelector('.login-inputs');
    const authStatus = document.getElementById('auth-status');
    
    loginInputs.style.display = 'flex';
    authStatus.style.display = 'none';
    document.getElementById('login-error').textContent = '';
    
    disableButtons();
  }

  socket.on('connect', () => {
    console.log('[WebSocket] Connect√©');
    if (token) {
      socket.emit('auth', token);
    }
  });

  // Mettre √† jour l'√©tat du broker MQTT
  socket.on('mqtt_status', (data) => {
    const statusEl = document.getElementById('status');
    if (data.connected) {
      statusEl.classList.add('connected');
      statusEl.textContent = 'MQTT Connect√©';
    } else {
      statusEl.classList.remove('connected');
      statusEl.textContent = 'MQTT D√©connect√©';
    }
  });

  socket.on('auth_success', (data) => {
    enableButtons();
    isAuthenticated = true;
    console.log('Authentifi√©:', data.username);
  });

  socket.on('auth_error', (data) => {
    disableButtons();
    isAuthenticated = false;
    console.error('Erreur auth:', data.message);
  });

  socket.on('disconnect', () => {
    document.getElementById('status').classList.remove('connected');
    document.getElementById('status').textContent = 'D√©connect√© du serveur';
  });

  function update(id, val, min, max) {
    const el = document.getElementById(id);
    const bubble = document.getElementById(id + '-bubble');
    
    bubble.classList.remove('healthy', 'warning', 'critical');
    if (val >= min && val <= max) bubble.classList.add('healthy');
    else if (Math.abs(val - min) < (max - min) * 0.2 || Math.abs(val - max) < (max - min) * 0.2) bubble.classList.add('warning');
    else bubble.classList.add('critical');
    
    el.textContent = (id === 'rssi' || id === 'pressure') ? Math.round(val) : val.toFixed(1);
  }

  function toggle(type, cmd) {
    if (!isAuthenticated) {
      setLoginError(''); // Pas de message rouge
      return;
    }
    states[type] = !states[type];
    const btn = document.getElementById(type + '-btn');
    if (states[type]) {
      btn.classList.add('on');
    } else {
      btn.classList.remove('on');
    }
    socket.emit('cmd', states[type] ? cmd + '_ON' : cmd + '_OFF');
  }

  socket.on('telemetry', d => {
    if (!d) return;
    
    // Mise √† jour des capteurs
    update('lux', d.luminosite || 0, 500, 10000);
    update('soil', d.humidite_sol || 0, 30, 70);
    update('temp', d.temperature || 0, 15, 30);
    update('pressure', d.pressure || 0, 990, 1030);
    update('rssi', d.rssi || -100, -70, -50);
    
    // Ajouter le nouveau point au graphique en temps r√©el
    if (chartData) {
      chartData.push({
        timestamp: new Date().toISOString(),
        luminosite: d.luminosite || 0,
        humidite_sol: d.humidite_sol || 0,
        temperature: d.temperature || 0,
        pressure: d.pressure || 0,
        rssi: d.rssi || 0,
        led_on: d.led_on || false,
        fan_on: d.fan_on || false,
        humidifier_on: d.humidifier_on || false
      });
      
      // Garder seulement les 100 derniers points
      if (chartData.length > 100) chartData.shift();
      
      // Actualiser le graphique
      renderChart(chartData);
    }
    
    // Synchroniser les √©tats des boutons
    if (d.led_on !== undefined) {
      states.led = d.led_on;
      const ledBtn = document.getElementById('led-btn');
      if (d.led_on) ledBtn.classList.add('on');
      else ledBtn.classList.remove('on');
    }
    if (d.fan_on !== undefined) {
      states.fan = d.fan_on;
      const fanBtn = document.getElementById('fan-btn');
      if (d.fan_on) fanBtn.classList.add('on');
      else fanBtn.classList.remove('on');
    }
    if (d.humidifier_on !== undefined) {
      states.hum = d.humidifier_on;
      const humBtn = document.getElementById('hum-btn');
      if (d.humidifier_on) humBtn.classList.add('on');
      else humBtn.classList.remove('on');
    }
  });

  let chartData = null; // Stockage des donn√©es du graphique

  function renderChart(data) {
    if (!data || data.length === 0) return;
    
    const ctx = document.getElementById('chart').getContext('2d');
    const labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
    
    if (chart) {
      // Mettre √† jour les donn√©es existantes sans d√©truire le graphique
      chart.data.labels = labels;
      chart.data.datasets[0].data = data.map(d => d.luminosite);
      chart.data.datasets[1].data = data.map(d => d.humidite_sol);
      chart.data.datasets[2].data = data.map(d => d.temperature || 0);
      chart.data.datasets[3].data = data.map(d => d.pressure || 0);
      chart.update('none'); // 'none' = pas d'animation, juste mise √† jour
      return;
    }
    
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Luminosit√© (lux)',
            data: data.map(d => d.luminosite),
            borderColor: '#fbbf24',
            backgroundColor: 'rgba(251,191,36,0.05)',
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.4,
            fill: true,
            yAxisID: 'y'
          },
          {
            label: 'Humidit√© (%)',
            data: data.map(d => d.humidite_sol),
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59,130,246,0.05)',
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.4,
            fill: true,
            yAxisID: 'y'
          },
          {
            label: 'Temp√©rature (¬∞C)',
            data: data.map(d => d.temperature || 0),
            borderColor: '#f97316',
            backgroundColor: 'rgba(249,115,22,0.05)',
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.4,
            fill: true,
            yAxisID: 'y'
          },
          {
            label: 'Pression (hPa)',
            data: data.map(d => d.pressure || 0),
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139,92,246,0.05)',
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.4,
            fill: true,
            yAxisID: 'y'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { left: 0, right: 0 } },
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: { color: '#94a3b8', usePointStyle: true, padding: 10 }
          },
          annotation: {
            drawTime: 'afterDraw'
          }
        },
        scales: {
          y: {
            type: 'linear',
            position: 'right',
            min: 0,
            max: 1500,
            ticks: { color: '#94a3b8', font: { weight: 'bold' }, callback: function(value) { return Math.round(value); } },
            grid: { color: 'rgba(148,163,184,0.1)' }
          },
          x: {
            ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 0 },
            grid: { color: 'rgba(255,255,255,0.05)' }
          }
        }
      },
      plugins: []
    });
  }

  function loadChart() {
    fetch('/api/history?limit=100')
      .then(r => r.json())
      .then(data => {
        chartData = data;
        renderChart(chartData);
      })
      .catch(err => console.error('Erreur chargement historique:', err));
  }

  loadChart(); // Charger une seule fois au d√©marrage
</script>
</body>
</html>